pipeline {
    agent any

    environment {
		DOCKERHUB_CREDENTIALS=credentials('dockerhub')
		PROJECT_ID = "x-plateau-436009-s9"
		CLUSTER-NAME = "gke-depi-project"
		LOCATION = "us-central1-c"
		CREDINTIAL_ID = "kubernates"
		
	}
    stages {
        stage('Docker Login') {
            steps {
                // Add --password-stdin to run docker login command non-interactively
                sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin'
            }
        }
        stage('Build & push Dockerfile') {
            steps {
                sh 'ansible-playbook ansible-playbook.yml'
            }
        }
	stage('Deploy to K8s') {
			    steps{
				    echo "Deployment started ..."
				    sh 'ls -ltr'
				    sh 'pwd'
				    sh "sed -i 's/tagversion/${env.BUILD_ID}/g' deployment.yaml"
					echo "Start deployment of deployment.yaml"
					step([$class: 'KubernetesEngineBuilder', projectId: env.PROJECT_ID, clusterName: env.CLUSTER_NAME, location: env.LOCATION, manifestPattern: 'deployment.yaml', credentialsId: env.CREDENTIALS_ID, verifyDeployments: true])
				    echo "Deployment Finished ..."
			    }
		    }
}
}
